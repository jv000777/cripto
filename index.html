<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>iXO · Cripto Monitor</title>
<link rel="icon" type="image/png" href="assets/favicon.png" sizes="32x32"/>

<style>
  :root{
    --bg:#0f1624; --card:#1a2235; --head:#121a2b; --muted:#aeb6cf; --ink:#fff;
    --up:#22c55e; --down:#ef4444; --line:#2a3246; --max:980px;
    --pill:#233046;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Arial,sans-serif}
  header{padding:22px 0 8px;text-align:center}
  .logoWrap{display:inline-grid;place-items:center;width:86px;height:86px;margin:0 auto 10px;border-radius:50%;
    background:radial-gradient(120px circle at 50% 45%, rgba(255,255,255,.06), rgba(255,255,255,0));
    box-shadow:0 8px 30px rgba(0,0,0,.35) inset, 0 8px 20px rgba(0,0,0,.25);
    cursor:pointer;
  }
  .logo{width:78px;height:78px;border-radius:50%;object-fit:contain;filter:brightness(1.35) contrast(1.15)}
  h1{font-size:2.6rem;margin:8px 0 4px}
  .sub{color:var(--muted);margin:0 0 6px}
  .upd{color:#9aa3b2;font-size:.9rem;margin:0 0 6px}
  .frase{color:#9aa3b2;font-size:.9rem;margin:0 0 18px;font-style:italic}
  header::after{content:"";display:block;height:1px;margin:14px auto 10px;width:92%;
    background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent)}
  .wrap{max-width:var(--max);margin:0 auto;padding:0 12px 28px}

  table{width:100%;border-collapse:separate;border-spacing:0;background:var(--card);
    border-radius:14px;overflow:hidden}
  thead th{background:var(--head);color:#cfd5ff;font-weight:700;padding:12px 10px}
  thead th.sortable{cursor:pointer;user-select:none}
  thead th.sortable:hover{filter:brightness(1.05)}
  thead .hdr{display:flex;align-items:center;gap:6px;justify-content:flex-start}
  thead .hdr.right{justify-content:flex-end}
  .arrow{opacity:.55;font-size:.9em;min-width:1ch}
  tbody td{padding:12px 10px;border-top:1px solid var(--line);vertical-align:middle;font-size:13px;}
  .name{display:flex;flex-direction:column;gap:4px}
  .name .sym{opacity:.85}
  .mc{font-size:11px;color:#aab3d1}
  .num{text-align:right;font-variant-numeric:tabular-nums}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:var(--pill);min-width:74px;text-align:center;font-size:13px;}
  .up{color:var(--up);background:rgba(34,197,94,.15)}
  .down{color:var(--down);background:rgba(239,68,68,.15)}
  .morebar{position:sticky;bottom:0;background:var(--head);color:#cfd5ff;padding:12px;
    text-align:center;cursor:pointer;border-top:1px solid var(--line)}
  .morebar:hover{filter:brightness(1.05)}
  .note{color:#97a1b9;font-size:.85rem;margin:10px 0 0;text-align:center}
  footer{color:#9aa3b2;text-align:center;font-size:12px;padding:18px}
  @media (min-width:700px){ h1{font-size:3rem} }

  /* Modal imagen */
  #imageModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:999; }
  #imageModal img { max-width:90%; max-height:90%; border-radius:8px; }

  /* Indicadores bajo el precio */
  .indi{font-size:11px;color:#aeb6cf;margin-top:6px;line-height:1.25}
  .indi .tf{margin-top:4px}
  .indi b{color:#cfd5ff}
  .rsi-hot{color:#ef7777;font-weight:700}   /* RSI > 93 */
  .rsi-cold{color:#4ade80;font-weight:700}  /* RSI < 7  */

  /* Señales (bolitas) */
  .sigline{margin-top:2px}
  .dot{display:inline-block;width:8px;height:8px;border-radius:50%;vertical-align:middle;margin-right:6px}
  .dot.green{background:#22c55e}
  .dot.red{background:#ef4444}
  .dot.gray{background:#94a3b8}
</style>
</head>

<body>
<header>
  <div class="logoWrap" id="logoClick"><img class="logo" src="assets/A.PNG" alt="iXO" /></div>
  <h1>iXO</h1>
  <p class="sub">Cripto · Monitor</p>
  <p class="upd" id="update-time">Última actualización: —</p>
  <p class="frase">Cuando nada es seguro, todo es posible.</p>
</header>

<div class="wrap">
  <table id="t">
    <thead>
      <tr>
        <th class="sortable" id="th-mc">
          <span class="hdr">Activo / MC <span class="arrow" id="arr-mc"></span></span>
        </th>
        <th class="num">Precio (USD)</th>
        <th class="sortable num" id="th-24h">
          <span class="hdr right">24h <span class="arrow" id="arr-24h"></span></span>
        </th>
        <th class="sortable num" id="th-7d">
          <span class="hdr right">7d <span class="arrow" id="arr-7d"></span></span>
        </th>
      </tr>
    </thead>
    <tbody id="rows"><tr><td colspan="4">Cargando…</td></tr></tbody>
    <tfoot>
      <tr><td colspan="4" id="morebar" class="morebar">MORE (+5)</td></tr>
    </tfoot>
  </table>
  <p class="note">Toque los encabezados “Activo / MC”, “24h” o “7d” para ordenar.</p>
</div>

<footer>© <span id="y"></span> jv000777 · GitHub Pages</footer>

<!-- Modal -->
<div id="imageModal">
  <img src="assets/A.PNG" alt="iXO grande">
</div>

<script>
/* ---------- FORMATTERS ---------- */
const nfUSD = new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:6});
const nfPct = new Intl.NumberFormat('en-US',{minimumFractionDigits:2,maximumFractionDigits:2,signDisplay:'exceptZero'});
const nfCompact = new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',notation:'compact',compactDisplay:'short',maximumFractionDigits:2});

/* ---------- EXCLUSIONES ---------- */
const EXCLUDE_IDS = new Set([
  "tether","usd-coin","dai","true-usd","pax-dollar","frax","usdd","first-digital-usd","usdp","binance-usd","gemini-dollar",
  "staked-ether","wrapped-bitcoin","weth","rocket-pool-eth","frax-ether","ankreth","cbeth","sfrxeth","reth","frxeth"
]);

/* ---------- SIEMPRE INCLUIR ---------- */
const ALWAYS_INCLUDE_IDS = ["pudgy-penguins"];

let FULL = [];
let shown = 10;
let sortKey = 'market_cap';
let sortDir = 'desc';

/* ----- LIVE desde CoinGecko ----- */
async function fetchLive(){
  const urlTop = 'https://api.coingecko.com/api/v3/coins/markets'
    + '?vs_currency=usd&order=market_cap_desc&per_page=200&page=1'
    + '&sparkline=false&price_change_percentage=24h,7d';
  const r1 = await fetch(urlTop, { cache:'no-store', headers:{accept:'application/json'}});
  if (!r1.ok) throw new Error('CG top HTTP '+r1.status);
  const top = await r1.json();

  let extra = [];
  if (ALWAYS_INCLUDE_IDS.length){
    const urlExtra = 'https://api.coingecko.com/api/v3/coins/markets'
      + `?vs_currency=usd&ids=${encodeURIComponent(ALWAYS_INCLUDE_IDS.join(','))}`
      + '&sparkline=false&price_change_percentage=24h,7d';
    const r2 = await fetch(urlExtra, { cache:'no-store', headers:{accept:'application/json'}});
    if (r2.ok) extra = await r2.json();
  }

  const map = new Map();
  [...top, ...extra].forEach(c => { if (c && c.id) map.set(c.id, c); });
  const data = [...map.values()];

  FULL = data
    .filter(c => c && c.id && !EXCLUDE_IDS.has(c.id.toLowerCase()))
    .map(c => ({
      id: c.id,
      name: c.name,
      symbol: (c.symbol||'').toUpperCase(),
      usd: c.current_price ?? null,
      change_24h: c.price_change_percentage_24h_in_currency ?? c.price_change_percentage_24h ?? null,
      change_7d:  c.price_change_percentage_7d_in_currency ?? null,
      market_cap: c.market_cap ?? null
    }))
    .sort((a,b)=> (b.market_cap??0)-(a.market_cap??0));

  document.getElementById('update-time').textContent = 'Última actualización: ' + new Date().toLocaleString();
}

/* ----- SNAPSHOT como respaldo ----- */
async function fetchSnapshot(){
  const res = await fetch('data/snapshot.json?ts=' + Date.now(), { cache:'no-store' });
  if (!res.ok) throw new Error('snapshot HTTP '+res.status);
  const j = await res.json();
  document.getElementById('update-time').textContent =
    'Última actualización: ' + (j.updated_at ? new Date(j.updated_at).toLocaleString() : '—');

  FULL = Object.entries(j.assets || {})
    .map(([sym, x]) => ({ ...x, symbol: x.symbol || sym }))
    .filter(x => x.id && !EXCLUDE_IDS.has(x.id.toLowerCase()))
    .sort((a,b)=> (b.market_cap??0)-(a.market_cap??0));
}

/* ----- Orden ----- */
function setSort(key){
  if (sortKey === key){
    sortDir = (sortDir === 'desc') ? 'asc' : 'desc';
  } else {
    sortKey = key; sortDir = 'desc';
  }
  render();
}
function cmp(a,b){
  const va = getVal(a, sortKey), vb = getVal(b, sortKey);
  const na = (va==null || Number.isNaN(va)), nb = (vb==null || Number.isNaN(vb));
  if (na && nb) return 0; if (na) return 1; if (nb) return -1;
  return sortDir==='desc' ? (vb-va) : (va-vb);
}
function getVal(x,k){
  if (k==='market_cap') return Number(x.market_cap ?? NaN);
  if (k==='change_24h') return Number(x.change_24h ?? NaN);
  if (k==='change_7d')  return Number(x.change_7d  ?? NaN);
  return NaN;
}
function updateArrows(){
  document.getElementById('arr-mc').textContent  = (sortKey==='market_cap') ? (sortDir==='desc'?'↓':'↑') : '';
  document.getElementById('arr-24h').textContent = (sortKey==='change_24h') ? (sortDir==='desc'?'↓':'↑') : '';
  document.getElementById('arr-7d').textContent  = (sortKey==='change_7d')  ? (sortDir==='desc'?'↓':'↑') : '';
}

/* ----- Render (sin indicadores; se inyectan después) ----- */
function render(){
  const list = [...FULL].sort(cmp).slice(0, shown);
  const tbody = document.getElementById('rows');
  tbody.innerHTML = '';
  for (const x of list){
    const price = x.usd!=null ? nfUSD.format(x.usd) : '—';
    const c24 = (typeof x.change_24h==='number') ? nfPct.format(x.change_24h)+'%' : '—';
    const c7  = (typeof x.change_7d ==='number') ? nfPct.format(x.change_7d) +'%' : '—';
    const cls24 = (typeof x.change_24h==='number') ? (x.change_24h>=0?'pill up':'pill down') : 'pill';
    const cls7  = (typeof x.change_7d ==='number') ? (x.change_7d >=0?'pill up':'pill down') : 'pill';
    const mcShort= x.market_cap!=null ? nfCompact.format(x.market_cap) : '—';
    const name = x.name || x.id || x.symbol || '';

    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>
          <div class="name">
            <strong>${name} <span class="sym">(${(x.symbol||'')})</span></strong>
            <span class="mc">· MC ${mcShort}</span>
          </div>
        </td>
        <td class="num">
          ${price}
          <!-- Indicadores se inyectan aquí vía JS (.indi) -->
        </td>
        <td class="num"><span class="${cls24}">${c24}</span></td>
        <td class="num"><span class="${cls7}">${c7}</span></td>
      </tr>
    `);
  }
  const mb = document.getElementById('morebar');
  const remaining = Math.max((FULL.length - shown), 0);
  mb.textContent = remaining>0 ? `MORE (+${Math.min(5,remaining)})` : 'LESS (top-10)';
  updateArrows();
}

/* ----- Ciclo de datos ----- */
async function refresh(){
  try{ await fetchLive(); }
  catch(e){
    console.warn('Live CG falló, uso snapshot:', e);
    try{ await fetchSnapshot(); }
    catch(e2){ console.error('Snapshot también falló:', e2);
      document.getElementById('rows').innerHTML = '<tr><td colspan="4">Error al cargar</td></tr>'; return; }
  }
  render();
}

/* ----- Sorting + More/Less ----- */
document.getElementById('th-mc').addEventListener('click', ()=>setSort('market_cap'));
document.getElementById('th-24h').addEventListener('click', ()=>setSort('change_24h'));
document.getElementById('th-7d').addEventListener('click',  ()=>setSort('change_7d'));
document.getElementById('morebar').addEventListener('click', ()=>{
  if (shown >= FULL.length){ shown = 10; } else { shown = Math.min(FULL.length, shown + 5); }
  render(); refreshIndicators();
});

/* ---------- INDICADORES (RSI8, MFI8, Stoch K8-sK3-D2) para 1h/4h/1D ---------- */
const INDI = {}; // {SYM: { '1h':{rsi8,mfi8,k,d,kPrev,dPrev}, ... }}

// Mapeo símbolo → par Binance (agrega excepciones si faltan)
const BINANCE_MAP = {
  BTC:'BTCUSDT', ETH:'ETHUSDT', SOL:'SOLUSDT', XRP:'XRPUSDT', ADA:'ADAUSDT',
  DOGE:'DOGEUSDT', LINK:'LINKUSDT', DOT:'DOTUSDT', BCH:'BCHUSDT', LTC:'LTCUSDT',
  TON:'TONUSDT', TRX:'TRXUSDT', AVAX:'AVAXUSDT', MATIC:'MATICUSDT',
  NEAR:'NEARUSDT', ICP:'ICPUSDT', FIL:'FILUSDT', APT:'APTUSDT',
  ARB:'ARBUSDT', OP:'OPUSDT', WLD:'WLDUSDT', KAS:'KASUSDT', XLM:'XLMUSDT'
};
const TF_MAP = { '1h':'1h', '4h':'4h', '1d':'1d' };

// Velas Binance
async function getKlines(pair, interval='1h', limit=200){
  const url = `https://api.binance.com/api/v3/klines?symbol=${pair}&interval=${interval}&limit=${limit}`;
  const r = await fetch(url, {cache:'no-store'});
  if(!r.ok) throw new Error('Binance '+r.status);
  const raw = await r.json();
  return raw.map(k=>({ open:+k[1], high:+k[2], low:+k[3], close:+k[4], volume:+k[5] }));
}

// RSI(8)
function rsiFromCloses(closes, period=8){
  if (closes.length < period+1) return null;
  const gains=[], losses=[];
  for(let i=1;i<closes.length;i++){
    const ch = closes[i]-closes[i-1];
    gains.push(ch>0?ch:0); losses.push(ch<0?-ch:0);
  }
  let ag = gains.slice(0,period).reduce((a,b)=>a+b,0)/period;
  let al = losses.slice(0,period).reduce((a,b)=>a+b,0)/period;
  for(let i=period;i<gains.length;i++){
    ag = (ag*(period-1)+gains[i])/period;
    al = (al*(period-1)+losses[i])/period;
  }
  const rs = ag/(al||1e-9);
  return 100 - (100/(1+rs));
}

// MFI(8)
function mfi(kl, period=8){
  if (kl.length < period+1) return null;
  const tp = i => (kl[i].high + kl[i].low + kl[i].close)/3;
  let pos=0, neg=0;
  for(let i=kl.length-period; i<kl.length; i++){
    const mf = tp(i) * kl[i].volume;
    const dir = tp(i) - tp(i-1);
    if (dir >= 0) pos += mf; else neg += mf;
  }
  const mr = pos/Math.max(neg,1e-9);
  return 100 - (100/(1+mr));
}

// Estocástico K=8, smoothK=3, D=2 (devolviendo también valores previos)
function stochKD(kl, len=8, smoothK=3, dLen=2){
  const need = len + smoothK + dLen + 2;
  if (kl.length < need) return {k:null,d:null,kPrev:null,dPrev:null};
  // crudos %K en ventanas desplazadas
  const rawK = (offs=0) => {
    const win = kl.slice(-(len+offs), kl.length - offs);
    const lo = Math.min(...win.map(c=>c.low));
    const hi = Math.max(...win.map(c=>c.high));
    const cl = kl[kl.length-1-offs].close;
    return hi===lo ? 0 : ((cl - lo)/(hi - lo))*100;
  };
  // kSlow actual = SMA de 3 rawK (offs 0..2)
  const k0 = rawK(0), k1 = rawK(1), k2 = rawK(2), k3 = rawK(3);
  const kSlow = (k0 + k1 + k2)/3;
  const kPrev = (k1 + k2 + k3)/3;      // kSlow previo
  const d     = (kSlow + kPrev)/2;     // D=2 como SMA(2)
  const dPrev = (kPrev + ((k2 + k3 + rawK(4))/3))/2; // D previo (aprox)
  return { k: kSlow, d, kPrev, dPrev };
}

// Calcula para 1h/4h/1D de un símbolo
async function fetchIndicatorsForSymbol(sym){
  const pair = BINANCE_MAP[sym] || (sym+'USDT');
  const out = {};
  for (const tf of Object.keys(TF_MAP)){
    try{
      const kl = await getKlines(pair, TF_MAP[tf], 200);
      const closes = kl.map(c=>c.close);
      const rsi8 = rsiFromCloses(closes, 8);
      const mfi8 = mfi(kl, 8);
      const {k,d,kPrev,dPrev} = stochKD(kl, 8, 3, 2);
      out[tf] = { rsi8, mfi8, k, d, kPrev, dPrev };
    }catch(e){ /* omitimos si falla */ }
  }
  if (Object.keys(out).length) INDI[sym] = out;
}

// Refresca indicadores para visibles
async function refreshIndicators(){
  const list = [...FULL].sort(cmp).slice(0, shown);
  await Promise.all(list.map(x => fetchIndicatorsForSymbol((x.symbol||'').toUpperCase())));
  render(); // re-pinta con indicadores
}

// Inyección visual tras render
const _renderOrig = render;
render = function(){
  _renderOrig();
  const current = [...FULL].sort(cmp).slice(0, shown);
  const rows = document.querySelectorAll('#rows tr');
  rows.forEach((tr, i) => {
    const item = current[i]; if (!item) return;
    const sym = (item.symbol||'').toUpperCase();
    const ind = INDI[sym]; if (!ind) return;
    const tdPrice = tr.children[1]; if (!tdPrice) return;
    if (tdPrice.querySelector('.indi')) return; // evita duplicar

    const fmt = v => (typeof v==='number' && isFinite(v)) ? v.toFixed(2) : '—';
    const rsiClass = v => (typeof v==='number' && v>93) ? 'rsi-hot' : (typeof v==='number' && v<7) ? 'rsi-cold' : '';
    const dot = c => `<span class="dot ${c}"></span>`;

    const block = (tfLabel) => {
      const d = ind[tfLabel]; if (!d) return '';
      // señales
      const rsiDot = (typeof d.rsi8==='number' && d.rsi8>93) ? 'red' :
                     (typeof d.rsi8==='number' && d.rsi8<7)  ? 'green' : 'gray';
      const currDiff = (d.k!=null && d.d!=null) ? (d.k - d.d) : null;
      const prevDiff = (d.kPrev!=null && d.dPrev!=null) ? (d.kPrev - d.dPrev) : null;
      const crossed = (currDiff!=null && prevDiff!=null && currDiff*prevDiff<0);
      const stDot = crossed ? (currDiff>0 ? 'green' : 'red') : 'gray';

      return `
        <div class="tf">
          <b>${tfLabel}</b><br>
          RSI: <span class="${rsiClass(d.rsi8)}">${fmt(d.rsi8)}</span> - MFI: ${fmt(d.mfi8)}<br>
          STCH: K${fmt(d.k)} / D${fmt(d.d)}
          <div class="sigline">${dot(rsiDot)}<span>RSI EXT</span></div>
          <div class="sigline">${dot(stDot)}<span>STCH CROSS</span></div>
        </div>
      `;
    };

    tdPrice.insertAdjacentHTML('beforeend', `
      <div class="indi">
        ${block('1h')}
        ${block('4h')}
        ${block('1d')}
      </div>
    `);
  });
};

/* ----- INIT ----- */
document.getElementById('y').textContent = new Date().getFullYear();
refresh();
setInterval(refresh, 30000);
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) refresh(); });

// Indicadores: al cargar y cada 3 min
setTimeout(refreshIndicators, 2000);
setInterval(refreshIndicators, 180000);

// Modal logo
document.getElementById('logoClick').addEventListener('click', function() {
  document.getElementById('imageModal').style.display = 'flex';
});
document.getElementById('imageModal').addEventListener('click', function() {
  this.style.display = 'none';
});
</script>
</body>
</html>